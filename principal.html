<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nile Urban Lounge</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.2.0/dist/index.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.2.0/dist/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA_vfbPHFvTTg6HbsqPD4ym50Q2pfxnLYU",
            authDomain: "nileurban-c9bd9.firebaseapp.com",
            projectId: "nileurban-c9bd9",
            storageBucket: "nileurban-c9bd9.appspot.com",
            messagingSenderId: "798328145085",
            appId: "1:798328145085:web:8ad8642e133fdd6fab63d4",
            measurementId: "G-44H22X36PS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        async function getRecords() {
            const today = getCurrentDate();
            const reservationsCol = collection(db, 'Reserva');
            const q = query(reservationsCol, where('fecha', '==', today));
            const querySnapshot = await getDocs(q);
            const appointmentList = document.getElementById('appointment-list');
            appointmentList.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const listItem = document.createElement('li');
                listItem.textContent = `${data.nombre} - ${data.fecha} - ${data.hora}hs - ${data.profesional} - ${data.servicio}`;
                appointmentList.appendChild(listItem);
            });
        }

        async function getReservationsForDateAndProfessional(date, professional) {
            const querySnapshot = await getDocs(query(
                collection(db, 'Reserva'),
                where('fecha', '==', date),
                where('profesional', '==', professional)
            ));
            const reservations = [];
            querySnapshot.forEach((doc) => {
                reservations.push(doc.data());
            });
            return reservations;
        }

        async function bookAppointment() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('calendar').value;
            const time = document.getElementById('time').value;
            const professional = document.getElementById('professional').value;
            const service = document.getElementById('service').value;

            if (name && date && time && professional && service) {
                const reservations = await getReservationsForDateAndProfessional(date, professional);
                const reservedTimes = reservations.map(reservation => reservation.hora);

                if (reservedTimes.includes(time)) {
                    alert('La hora seleccionada ya está reservada. Por favor, elige otra hora.');
                    return;
                }

                try {
                    await addDoc(collection(db, 'Reserva'), {
                        nombre: name,
                        fecha: date,
                        hora: time,
                        profesional: professional,
                        servicio: service
                    });
                    alert('Reserva realizada con éxito');
                    await getRecords();
                } catch (error) {
                    console.error('Error al añadir la reserva: ', error);
                }
            } else {
                alert('Por favor, completa todos los campos.');
            }
        }

        async function populateTimeOptions() {
            const timeSelect = document.getElementById('time');
            const schedule = { startHour: 11, endHour: 18, interval: 30 };
            const { startHour, endHour, interval } = schedule;
            const date = document.getElementById('calendar').value;
            const professional = document.getElementById('professional').value;

            if (!date || !professional) return;

            const reservations = await getReservationsForDateAndProfessional(date, professional);
            const reservedTimesForDateAndProfessional = reservations.map(reservation => reservation.hora);

            timeSelect.innerHTML = '';

            for (let hour = startHour; hour <= endHour; hour++) {
                for (let minutes = 0; minutes < 60; minutes += interval) {
                    if (hour === endHour && minutes > 60 - interval) break;
                    const hourDisplay = hour < 10 ? `0${hour}` : hour;
                    const minutesDisplay = minutes === 0 ? '00' : minutes;
                    const optionValue = `${hourDisplay}:${minutesDisplay}`;
                    const optionText = `${hourDisplay}:${minutesDisplay}hs`;

                    const option = document.createElement('option');
                    option.value = optionValue;
                    option.textContent = optionText;

                    if (!reservedTimesForDateAndProfessional.includes(option.value)) {
                        timeSelect.appendChild(option);
                    }
                }
            }
        }

        function showAdminModal() {
            document.getElementById('admin-auth-modal').style.display = 'flex';
        }

        function hideAdminModal() {
            document.getElementById('admin-auth-modal').style.display = 'none';
        }

        async function authenticateAdmin() {
            const password = document.getElementById('admin-password').value;
            const correctPassword = 'nico1234'; // Reemplaza con la contraseña real

            if (password === correctPassword) {
                hideAdminModal();
                document.querySelector('.reservations').style.display = 'block'; // Muestra la lista de turnos reservados
                await getRecords(); // Actualiza la lista de reservas
            } else {
                document.getElementById('auth-error-message').style.display = 'block';
            }
        }

        // Llama a la función para obtener los documentos al cargar la página
        window.onload = () => {
            getRecords();

            document.getElementById('book-button').addEventListener('click', bookAppointment);

            // Actualizar opciones de hora cuando se seleccione la fecha o el profesional
            document.getElementById('calendar').addEventListener('change', populateTimeOptions);
            document.getElementById('professional').addEventListener('change', populateTimeOptions);
        };
           
            document.querySelector('.close-btn').addEventListener('click', hideAdminModal);
            document.getElementById('admin-auth-btn').addEventListener('click', authenticateAdmin);
        
    </script>
    <style>
        /* Estilo del modal */
        .modal {
            display: none; /* Oculta el modal por defecto */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <div class="brand-image">
            <img src="images/nile_header.jpg" alt="Marca">
        </div>
    </header>

    <div class="container">
        <div class="booking-form">
            <label for="name">NOMBRE COMPLETO:</label>
            <input type="text" id="name" required>

            <div class="form-row">
                <div class="form-group">
                    <label for="professional">PROFESIONAL:</label>
                    <select id="professional" required>
                        <option value="Nicolas">Nicolas</option>
                        <option value="Lautaro">Lautaro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="calendar">FECHA:</label>
                    <input type="text" id="calendar" required>
                </div>
            </div>

            <label for="time">HORA:</label>
            <select id="time" required></select>

            <label for="service">SERVICIOS:</label>
            <select id="service" required>
                <option value="Corte">Corte $8.500</option>
                <option value="Corte + Barba">Corte + Barba $10.000</option>
                <option value="Barba">Barba $7.500</option>
            </select>

            <button id="book-button">RESERVAR</button>
        </div>
        
        <div class="reservations" style="display: none;">
            <h2>TURNOS RESERVADOS</h2>
            <ul id="appointment-list"></ul>
        </div>

        <button id="admin-button">Administración</button>
    </div>

    <div id="admin-auth-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Autenticación de Administrador</h2>
            <p>Por favor, ingresa la contraseña para acceder al panel de administrador.</p>
            <input type="password" id="admin-password" placeholder="Contraseña">
            <button id="admin-auth-btn">Ingresar</button>
            <p id="auth-error-message" style="color: red; display: none;">Contraseña incorrecta, por favor inténtalo de nuevo.</p>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="contact-info">
                <p><strong>Dirección: </strong>Av. De Mayo 702 - Ramos Mejia</p>
                <p><strong>Horarios:</strong> Martes a Sábado: 10:30 - 20:00</p>
            </div>
            <div class="social-media">
                <a href="https://www.instagram.com/nile.urbanlounge" target="_blank" title="Síguenos en Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://www.tiktok.com/@nile.urban" target="_blank" title="Síguenos en TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>    
            </div>
        </div>
    </footer>
</body>
</html>
